<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Label Score Report</title>
  <style>
    body{font-family:system-ui;margin:20px;max-width:980px}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    img{max-width:240px;border-radius:12px;border:1px solid #ddd}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #ddd;margin-right:8px}
    .big{font-size:28px;font-weight:700}
    .muted{color:#666}
    pre{background:#f6f6f6;padding:12px;border-radius:12px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <div class="big">Label Score Report</div>
    <div class="muted" id="status">Loading…</div>
  </div>

  <div id="main" style="display:none;">
    <div class="card">
      <div class="row">
        <div>
          <img id="img" alt="Best label image" />
        </div>
        <div style="flex:1;min-width:260px;">
          <div class="big" id="verdict"></div>
          <div><span class="pill" id="score"></span><span class="pill" id="confidence"></span></div>
          <div style="margin-top:8px;font-weight:600;" id="title"></div>
          <div class="muted" id="asin"></div>
          <div style="margin-top:12px;" id="reasons"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Extracted Nutrition</div>
      <pre id="nutrition"></pre>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Ingredients</div>
      <pre id="ingredients"></pre>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Suggestions</div>
      <pre id="suggestions"></pre>
    </div>
  </div>

  <script>
    // paste your Apps Script Web App URL here:
    const API = "https://script.google.com/macros/s/AKfycbwWe2w-EJ3Oz1aslnKafCZj19akZWOSjUkj2m_orS08kMhk8lH8wxMv0D-soHfgvix_tw/exec";

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        window[cb] = (data) => { cleanup(); resolve(data); };
        const s = document.createElement("script");
        const t = setTimeout(() => { cleanup(); reject(new Error("Timeout")); }, 20000);
        function cleanup(){
          clearTimeout(t);
          s.remove();
          try{ delete window[cb]; } catch(e){ window[cb] = undefined; }
        }
        s.onerror = () => { cleanup(); reject(new Error("Load failed")); };
        const sep = url.includes("?") ? "&" : "?";
        s.src = url + sep + "callback=" + cb;
        document.body.appendChild(s);
      });
    }

    function esc(s){ return String(s||""); }

    (async function(){
      const rid = getParam("rid");
      if(!rid){
        document.getElementById("status").textContent = "Missing rid. Open this from the extension.";
        return;
      }
      try{
        const data = await jsonp(`${API}?action=get&rid=${encodeURIComponent(rid)}`);
        if(!data.ok){
          document.getElementById("status").textContent = "Error: " + esc(data.error);
          return;
        }
        document.getElementById("status").textContent = "Loaded.";
        document.getElementById("main").style.display = "block";

        document.getElementById("img").src = data.bestImageUrl || "";
        document.getElementById("verdict").textContent = esc(data.verdict || "");
        document.getElementById("score").textContent = "Score: " + esc(data.score);
        document.getElementById("confidence").textContent = "Confidence: " + esc(data.confidence);
        document.getElementById("title").textContent = esc(data.title || "");
        document.getElementById("asin").textContent = data.asin ? ("ASIN: " + data.asin) : "";

        const reasons = (data.topReasons || []).map(r => "• " + r).join("\n");
        document.getElementById("reasons").innerHTML = "<pre>"+esc(reasons)+"</pre>";

        document.getElementById("nutrition").textContent = JSON.stringify(data.extracted || {}, null, 2);
        document.getElementById("ingredients").textContent = esc((data.extracted && data.extracted.ingredientsText) || "");
        document.getElementById("suggestions").textContent = (data.suggestions || []).join("\n") || "None";

      } catch(e){
        document.getElementById("status").textContent = "Error: " + e.message;
      }
    })();
  </script>
</body>
</html>
